<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MotoMeter SF Ultimate - V2.0 HUD Navi</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');

        :root {
            --bg-color: #05080a;
            --text-color: #00ffff;
            --needle-main: #ff0055;
            --btn-bg: rgba(0,255,255,0.05);
            --orange-z: #ffa500;
            --nav-color: #ffff00;
            --nav-widget-bg: rgba(0,0,0,0.5);
        }

        body.inverted {
            --bg-color: #dcdcdc;
            --text-color: #000;
            --needle-main: #d00;
            --btn-bg: rgba(0,0,0,0.05);
            --orange-z: #d47a00;
            --nav-color: #ff4500;
            --nav-widget-bg: rgba(255,255,255,0.8);
        }

        body { 
            background: var(--bg-color); color: var(--text-color); 
            font-family: 'Orbitron', sans-serif, Arial; text-align: center; 
            margin: 0; overflow: hidden; display: flex; flex-direction: column;
            justify-content: center; align-items: center; height: 100vh;
            touch-action: manipulation;
        }

        #speed-particles { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
        #gauge-container { position: relative; z-index: 1; display: flex; flex-direction: column; align-items: center; width: 100%; }
        
        canvas { width: 100vw; max-width: 600px; height: auto; }
        
        #digital-display-container { 
            margin-top: -80px; height: 130px; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; width: 320px; pointer-events: none;
        }

        .digital-value { font-weight: 700; line-height: 1.0; white-space: nowrap; letter-spacing: -1px; }
        #gps-speed-big { font-size: 5.2rem; color: #fff; text-shadow: 0 0 15px rgba(0,255,255,0.3); }
        body.inverted #gps-speed-big { color: #000; text-shadow: none; }
        #digital-rpm-small { font-size: 2.6rem; color: var(--text-color); opacity: 0.95; }
        .unit-label { font-size: 0.8rem; opacity: 0.5; margin-left: 5px; font-weight: 400; }

        #nav-widget {
            position: absolute;
            top: env(safe-area-inset-top, 20px);
            left: 50%;
            transform: translateX(-50%);
            z-index: 500;
            display: none; 
            flex-direction: row; 
            align-items: center;
            gap: 15px; 
            pointer-events: none;
            background: var(--nav-widget-bg);
            padding: 8px 20px;
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(5px);
        }
        
        #nav-arrow {
            width: 40px; 
            height: 50px; 
            background-color: var(--nav-color);
            clip-path: polygon(50% 0%, 0% 100%, 50% 80%, 100% 100%);
            transform-origin: center center;
        }

        #nav-dist { font-size: 2.2rem; font-weight: 700; color: var(--nav-color); line-height: 1; }

        #learn-status {
            position: absolute;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            color: #ff0055;
            font-weight: bold;
            font-size: 1.2rem;
            display: none;
            z-index: 10;
            text-shadow: 0 0 10px #000;
        }

        #settings-page {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); display: none; flex-direction: column;
            z-index: 2000; overflow-y: auto; padding-bottom: 40px;
        }
        
        #map { 
            width: 90%; 
            height: 300px; 
            margin: 10px auto; 
            border: 2px solid var(--text-color); 
            border-radius: 8px; 
            background: #222; 
        }

        .setting-group { margin: 8px; text-align: center; }
        label { font-size: 0.75rem; opacity: 0.8; display: block; margin-bottom: 4px; font-weight: bold; }
        select, input { font-family: inherit; font-size: 1.2rem; padding: 8px; background: rgba(0,0,0,0.2); color: var(--text-color); border: 1px solid var(--text-color); text-align: center; width: 240px; border-radius: 4px; }
    </style>
</head>
<body>

    <canvas id="speed-particles"></canvas>

    <div id="nav-widget">
        <div id="nav-arrow-container"><div id="nav-arrow"></div></div>
        <div id="nav-dist">0m</div>
    </div>

    <div id="learn-status">READY FOR 1ST GEAR</div>

    <div id="gauge-container">
        <canvas id="gaugeCanvas" width="600" height="600"></canvas>
        <div id="digital-display-container">
            <div id="digital-rpm-small" class="digital-value">0<span class="unit-label">RPM</span></div>
            <div id="gps-speed-big" class="digital-value">0<span class="unit-label">km/h</span></div>
        </div>
    </div>

    <div class="controls">
        <button id="bleConnectBtn" class="btn">BT Connect</button>
        <button id="autoLearnBtn" class="btn">Auto Learn</button>
        <button id="demoBtn" class="btn">Demo</button>
        <button id="configBtn" class="btn">Settings / Map</button>
    </div>

    <div id="settings-page">
        <h2 style="letter-spacing:3px; margin-top: 30px;">SYSTEM SETTINGS</h2>
        <div style="border: 1px solid var(--text-color); width: 92%; margin: 10px auto; padding: 15px 10px; border-radius: 8px; background: rgba(0,0,0,0.3);">
            <div id="map"></div>
            <div class="setting-group" style="display: flex; justify-content: center; gap: 10px;">
                <input type="number" id="target-lat" step="0.000001" placeholder="Lat" style="width: 110px;">
                <input type="number" id="target-lon" step="0.000001" placeholder="Lon" style="width: 110px;">
            </div>
            <button id="clearNavBtn" class="btn" style="margin-top:10px; border-color:#f00; color:#f00;">CLEAR DESTINATION</button>
        </div>
        <div class="setting-group"><label>DARK / LIGHT MODE</label><select id="invert-select"><option value="false">DARK</option><option value="true">LIGHT</option></select></div>
        <div class="setting-group"><label>PPR (PULSE / REV)</label><select id="ppr-select"><option value="0.5">0.5</option><option value="1.0" selected>1.0</option><option value="2.0">2.0</option></select></div>
        <div class="setting-group"><label>MAX RPM SCALE</label><select id="range-select"><option value="10000">10,000</option><option value="15000">15,000</option><option value="20000">20,000</option></select></div>
        <div class="setting-group"><label>RED LINE START</label><input type="number" id="red-line-input" value="9000"></div>
        <div class="setting-group"><label>SHIFT LIMIT (FLASH)</label><input type="number" id="shift-limit-input" value="9500"></div>
        <button id="closeConfigBtn" class="btn" style="margin: 20px 0 50px 0; background: var(--text-color); color: var(--bg-color); padding: 15px 80px;">APPLY & SAVE</button>
    </div>

    <script>
        const canvas = document.getElementById('gaugeCanvas');
        const ctx = canvas.getContext('2d');
        const bgCanvas = document.getElementById('speed-particles');
        const bctx = bgCanvas.getContext('2d');
        const rpmEl = document.getElementById('digital-rpm-small');
        const spdEl = document.getElementById('gps-speed-big');
        const learnStatusEl = document.getElementById('learn-status');
        const navWidget = document.getElementById('nav-widget');
        const navArrow = document.getElementById('nav-arrow');
        const navDist = document.getElementById('nav-dist');

        bgCanvas.width = window.innerWidth;
        bgCanvas.height = window.innerHeight;

        let rpm = 0, displayRpm = 0, speedKmH = 0, gear = "Z";
        let ppr = 1.0, currentHeading = 0, displayHeading = 0;
        let curLat = 0, curLon = 0, targetLat = 0, targetLon = 0;
        let peakRpm = 0, peakTimestamp = 0, peakDuration = 3000;
        let maxRpm = 10000, redLine = 9000, shiftLimit = 9500, isInverted = false;
        let isDemo = false, demoTime = 0, stars = [], isAutoLearning = false;
        let ratios = JSON.parse(localStorage.getItem('motoMeterRatios')) || [0,0,0,0,0,0];
        let stableCounter = 0, lastRatio = 0;
        const LEARN_RPM_TARGET = 3000;
        const LEARN_RPM_MARGIN = 500;
        const LEARN_STABLE_TIME_FRAMES = 300;

        let map = null, marker = null;
        let bluetoothDevice = null, isAutoReconnecting = false, wakeLock = null;

        const requestWakeLock = async () => {
            try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
        };

        function initMap() {
            if (map) {
                setTimeout(() => { map.invalidateSize(); }, 100);
                return;
            }
            map = L.map('map').setView([targetLat || 35.68, targetLon || 139.69], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            if (targetLat && targetLon) marker = L.marker([targetLat, targetLon]).addTo(map);
            map.on('click', (e) => {
                const lat = e.latlng.lat.toFixed(6), lon = e.latlng.lng.toFixed(6);
                document.getElementById('target-lat').value = lat;
                document.getElementById('target-lon').value = lon;
                if (marker) marker.setLatLng(e.latlng); else marker = L.marker(e.latlng).addTo(map);
            });
            setTimeout(() => { map.invalidateSize(); }, 300);
        }

        function startGPS() {
            requestWakeLock();
            if ("geolocation" in navigator) {
                navigator.geolocation.watchPosition((pos) => {
                    curLat = pos.coords.latitude; curLon = pos.coords.longitude;
                    if (!isDemo && pos.coords.speed !== null) speedKmH = pos.coords.speed * 3.6;
                    if (pos.coords.speed && speedKmH > 5 && pos.coords.heading !== null) currentHeading = pos.coords.heading;
                }, null, { enableHighAccuracy: true });
                window.addEventListener("deviceorientation", (e) => {
                    if (speedKmH <= 5) currentHeading = e.webkitCompassHeading || (360 - e.alpha);
                }, true);
            }
        }

        async function connectBLE() {
            startGPS();
            try {
                if (!bluetoothDevice) {
                    bluetoothDevice = await navigator.bluetooth.requestDevice({ 
                        filters: [{ namePrefix: 'Moto' }], 
                        optionalServices: ["6e400001-b5a3-f393-e0a9-e50e24dcca9e"] 
                    });
                    bluetoothDevice.addEventListener('gattserverdisconnected', onDisconnected);
                }
                await doConnect();
            } catch (err) { bluetoothDevice = null; }
        }

        async function doConnect() {
            if (!bluetoothDevice) return;
            try {
                const server = await bluetoothDevice.gatt.connect();
                const service = await server.getPrimaryService("6e400001-b5a3-f393-e0a9-e50e24dcca9e");
                const char = await service.getCharacteristic("6e400003-b5a3-f393-e0a9-e50e24dcca9e");
                await char.startNotifications();
                char.addEventListener('characteristicvaluechanged', (e) => {
                    const val = new TextDecoder().decode(e.target.value).trim();
                    if (val !== "" && !isNaN(val)) rpm = parseInt(val) / (ppr || 1.0);
                });
                document.getElementById('bleConnectBtn').innerText = "Connected";
                isAutoReconnecting = false;
            } catch (e) { if (isAutoReconnecting) setTimeout(doConnect, 5000); }
        }

        function onDisconnected() {
            document.getElementById('bleConnectBtn').innerText = "Reconnecting...";
            isAutoReconnecting = true;
            setTimeout(doConnect, 5000);
        }

        function getBearing(lat1, lon1, lat2, lon2) {
            const φ1 = lat1 * Math.PI/180, φ2 = lat2 * Math.PI/180, Δλ = (lon2-lon1) * Math.PI/180;
            return (Math.atan2(Math.sin(Δλ)*Math.cos(φ2), Math.cos(φ1)*Math.sin(φ2)-Math.sin(φ1)*Math.cos(φ2)*Math.cos(Δλ)) * 180/Math.PI + 360) % 360;
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3, dφ = (lat2-lat1)*Math.PI/180, dλ = (lon2-lon1)*Math.PI/180;
            const a = Math.sin(dφ/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dλ/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function updateGearLogic() {
            if (speedKmH >= 5 && rpm > 0) {
                const currentRatio = rpm / speedKmH;
                if (isAutoLearning) {
                    const inRpm = (rpm >= (LEARN_RPM_TARGET - LEARN_RPM_MARGIN) && rpm <= (LEARN_RPM_TARGET + LEARN_RPM_MARGIN));
                    if (inRpm && Math.abs(currentRatio - lastRatio) < (currentRatio * 0.02)) {
                        stableCounter++;
                        learnStatusEl.style.display = "block";
                        const gearLabel = ratios.every(r => r === 0) ? "1st GEAR" : "NEXT GEAR";
                        learnStatusEl.innerText = `${gearLabel} LEARNING: ${Math.round((stableCounter/LEARN_STABLE_TIME_FRAMES)*100)}%`;
                        if (stableCounter >= LEARN_STABLE_TIME_FRAMES) {
                            if (ratios.every(r => r === 0)) ratios[0] = currentRatio;
                            else if (!ratios.some(r => Math.abs(r - currentRatio) < (r * 0.1))) {
                                for (let i=0; i<6; i++) { if (ratios[i] === 0) { ratios[i] = currentRatio; ratios.sort((a,b)=>b-a); break; } }
                            }
                            localStorage.setItem('motoMeterRatios', JSON.stringify(ratios));
                            stableCounter = 0;
                            learnStatusEl.innerText = "GEAR RATIO SAVED!";
                            setTimeout(() => { if(stableCounter === 0) learnStatusEl.style.display = "none"; }, 2000);
                        }
                    } else {
                        stableCounter = 0;
                        if(inRpm) { learnStatusEl.style.display = "block"; learnStatusEl.innerText = "KEEP 3000RPM..."; }
                        else learnStatusEl.style.display = "none";
                    }
                    lastRatio = currentRatio;
                }
                let best = "Z", minD = 999;
                ratios.forEach((r, i) => { if (r === 0) return; const d = Math.abs(currentRatio - r); if (d < minD && d < (r * 0.12)) { minD = d; best = (i+1).toString(); } });
                gear = best;
            } else { gear = "Z"; learnStatusEl.style.display = "none"; }
        }

        class Star {
            constructor() { this.reset(); }
            reset() { this.x=(Math.random()-0.5)*bgCanvas.width; this.y=(Math.random()-0.5)*bgCanvas.height; this.z=bgCanvas.width; }
            update(s) { this.z -= s; if (this.z <= 1) this.reset(); }
            draw() {
                const f = bgCanvas.width/this.z;
                bctx.fillStyle = isInverted ? `rgba(0,0,0,${Math.min(0.3, f*0.05)})` : `rgba(0,255,255,${Math.min(1, f*0.1)})`;
                bctx.beginPath(); bctx.arc(this.x*f+bgCanvas.width/2, this.y*f+bgCanvas.height/2, f, 0, Math.PI*2); bctx.fill();
            }
        }
        for(let i=0; i<80; i++) stars.push(new Star());

        function drawCompass(cx, cy, radius) {
            const arc = 120 * Math.PI/180;
            ctx.save(); ctx.beginPath(); ctx.moveTo(cx, cy); ctx.arc(cx, cy, radius+40, -Math.PI/2-arc/2, -Math.PI/2+arc/2); ctx.clip();
            let diff = currentHeading - displayHeading;
            if (diff > 180) diff -= 360; if (diff < -180) diff += 360;
            displayHeading += diff * 0.1;
            for (let i=0; i<360; i+=5) {
                let rel = i - displayHeading;
                while (rel > 180) rel -= 360; while (rel < -180) rel += 360;
                if (Math.abs(rel) > 70) continue;
                const ang = -Math.PI/2 + (rel * Math.PI/180);
                ctx.beginPath(); ctx.moveTo(cx+Math.cos(ang)*(radius-8), cy+Math.sin(ang)*(radius-8)); ctx.lineTo(cx+Math.cos(ang)*(radius+8), cy+Math.sin(ang)*(radius+8));
                ctx.strokeStyle = isInverted ? "#000" : "#0ff"; ctx.lineWidth = (i%90===0)?3:1; ctx.stroke();
                if (i%45===0) {
                    ctx.fillStyle = (i%90===0)?(isInverted?"#000":"#fff"):(isInverted?"#333":"#0ff");
                    ctx.font = (i%90===0)?"bold 18px Orbitron":"bold 13px Orbitron"; ctx.textAlign="center";
                    ctx.fillText({0:"N",45:"NE",90:"E",135:"SE",180:"S",225:"SW",270:"W",315:"NW"}[i], cx+Math.cos(ang)*(radius+28), cy+Math.sin(ang)*(radius+28));
                }
            }
            ctx.restore();
            ctx.beginPath(); ctx.moveTo(cx, cy-radius+10); ctx.lineTo(cx-8, cy-radius+24); ctx.lineTo(cx+8, cy-radius+24); ctx.fillStyle="#ff0055"; ctx.fill();
        }

        function draw() {
            if (isDemo) { rpm = 3000; speedKmH = 40; currentHeading = (Date.now()/100)%360; } else updateGearLogic();
            bctx.fillStyle = isInverted ? "#dcdcdc" : "#05080a"; bctx.fillRect(0,0, bgCanvas.width, bgCanvas.height);
            stars.forEach(s => { s.update(speedKmH/12+0.3); s.draw(); });
            updateNavWidget(); ctx.clearRect(0,0,600,600);
            const cx=300, cy=300; drawCompass(cx, cy, 265);
            const startA=0.75*Math.PI, totalA=1.5*Math.PI, bR=235, bW=55;
            ctx.beginPath(); ctx.arc(cx, cy, bR, 0.73*Math.PI, 0.27*Math.PI); ctx.strokeStyle=isInverted?"#bbb":"#111"; ctx.lineWidth=bW; ctx.stroke();
            displayRpm += (rpm - displayRpm) * 0.15;
            const ratio = Math.min(displayRpm/maxRpm, 1);
            if (ratio > 0) {
                ctx.beginPath(); ctx.arc(cx, cy, bR+bW/2-6, startA, startA+ratio*totalA);
                ctx.strokeStyle = (displayRpm>=shiftLimit && (Date.now()%100<50))?"#fff":`hsla(${180-ratio*180},100%,50%,0.8)`;
                ctx.lineWidth=12; ctx.lineCap="round"; ctx.stroke();
            }
            ctx.beginPath(); ctx.arc(cx, cy, bR-bW/2, 0.73*Math.PI, 0.27*Math.PI); ctx.strokeStyle=isInverted?"#000":"#0ff"; ctx.lineWidth=2; ctx.stroke();
            for (let i=0; i<=maxRpm/500; i++) {
                const a = startA+(i/(maxRpm/500))*totalA;
                ctx.beginPath(); ctx.moveTo(cx+Math.cos(a)*(bR-bW/2-8), cy+Math.sin(a)*(bR-bW/2-8)); ctx.lineTo(cx+Math.cos(a)*(bR-bW/2-20), cy+Math.sin(a)*(bR-bW/2-20));
                ctx.strokeStyle = (i*500>=redLine)?"#f00":(isInverted?"#000":"#0ff"); ctx.lineWidth=(i%2===0)?4:2; ctx.stroke();
                if (i%2===0) { ctx.fillStyle=(i*500>=redLine)?"#f00":(isInverted?"#000":"#fff"); ctx.font="bold 34px Orbitron"; ctx.fillText(i/2, cx+Math.cos(a)*(bR-8), cy+Math.sin(a)*(bR-8)); }
            }
            const nL = bR-bW/2-15;
            ctx.save(); ctx.translate(cx, cy); ctx.rotate(startA+(Math.min(displayRpm, maxRpm)/maxRpm)*totalA);
            ctx.beginPath(); ctx.moveTo(-35, -6); ctx.lineTo(nL, -1.5); ctx.lineTo(nL, 1.5); ctx.lineTo(-35, 6); ctx.fillStyle="#ff0055"; ctx.fill(); ctx.restore();
            ctx.beginPath(); ctx.arc(cx, cy, 55, 0, Math.PI*2); ctx.fillStyle=isInverted?"#999":"#000"; ctx.fill();
            ctx.fillStyle=(gear==="Z")?(isInverted?"#d47a00":"#ffa500"):(isInverted?"#000":"#fff");
            ctx.font="bold 70px Orbitron"; ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText(gear, cx, cy);
            rpmEl.innerHTML = `${Math.round(displayRpm)}<span class="unit-label">RPM</span>`;
            spdEl.innerHTML = `${Math.round(speedKmH)}<span class="unit-label">km/h</span>`;
            requestAnimationFrame(draw);
        }

        function loadSettings() {
            targetLat = parseFloat(localStorage.getItem('motoNavLat')||0); targetLon = parseFloat(localStorage.getItem('motoNavLon')||0);
            ppr = parseFloat(localStorage.getItem('motoMeterPPR')||1.0); maxRpm = parseInt(localStorage.getItem('motoMeterRange')||10000);
            redLine = parseInt(localStorage.getItem('motoMeterRedLine')||9000); shiftLimit = parseInt(localStorage.getItem('motoMeterShiftLimit')||9500);
            isInverted = localStorage.getItem('motoMeterInvert')==="true";
            if (isInverted) document.body.classList.add('inverted');
        }

        document.getElementById('configBtn').onclick = () => { 
            document.getElementById('settings-page').style.display='flex'; 
            initMap(); 
        };
        document.getElementById('closeConfigBtn').onclick = () => {
            localStorage.setItem('motoNavLat', document.getElementById('target-lat').value);
            localStorage.setItem('motoNavLon', document.getElementById('target-lon').value);
            localStorage.setItem('motoMeterInvert', document.getElementById('invert-select').value);
            localStorage.setItem('motoMeterRange', document.getElementById('range-select').value);
            localStorage.setItem('motoMeterRedLine', document.getElementById('red-line-input').value);
            localStorage.setItem('motoMeterShiftLimit', document.getElementById('shift-limit-input').value);
            localStorage.setItem('motoMeterPPR', document.getElementById('ppr-select').value);
            location.reload(); 
        };
        document.getElementById('bleConnectBtn').onclick = connectBLE;
        document.getElementById('autoLearnBtn').onclick = (e) => { 
            isAutoLearning = !isAutoLearning; 
            e.target.classList.toggle('active'); 
            if(isAutoLearning) { ratios = [0,0,0,0,0,0]; localStorage.setItem('motoMeterRatios', JSON.stringify(ratios)); stableCounter = 0; }
        };
        loadSettings(); startGPS(); draw();
    </script>
</body>
</html>